#!/usr/bin/env node

var AssetGraph = require('../lib/AssetGraph'),
    transforms = require('../lib/transforms'),
    fileUtils = require('../lib/fileUtils'),
    commandLineOptions = require('../lib/camelOptimist')({usage: 'FIXME', demand: ['root', 'out-root', 'static-dir']}),
    assetGraph = new AssetGraph({root: commandLineOptions.root}),
    outRoot = fileUtils.fsPathToFileUrl(commandLineOptions.outRoot, true), // forceDirectory
    staticDir = commandLineOptions.staticDir || 'static',
    htmlAssets = [];

assetGraph.transform(
    function createStaticDir(assetGraph, cb) {
        fileUtils.mkpath(fileUtils.fileUrlToFsPath(outRoot) + staticDir, cb);
    },
    transforms.addAssets(commandLineOptions._),
    transforms.populate(function (relation) {
        return relation.type !== 'JavaScriptStaticInclude';
    }),
    transforms.bundleJavaScriptAndCSS(),
    transforms.spriteBackgroundImages(),
    transforms.addPNG8FallbackForIE6(),
    transforms.addCacheManifestSinglePage(), // Query?
    transforms.minifyAssets(),
    transforms.moveAssetsToStaticDir(staticDir),
    transforms.writeAssetsToDisc(outRoot)
);
