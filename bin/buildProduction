#!/usr/bin/env node

var _ = require('underscore'),
    AssetGraph = require('../lib/AssetGraph'),
    transforms = AssetGraph.transforms,
    query = AssetGraph.query,
    urlTools = require('../lib/util/urlTools'),
    commandLineOptions = require('optimist').
        usage('$0 --root <inputRootDirectory> [--label <labelName>=<dir> ...] --outroot <outputRootDirectory> [--locale <localeId>,...] [--cdnroot <url>] [--manifest] <htmlFile>...').
        boolean('manifest').
        demand(['root', 'outroot']).
        argv,
    outroot = urlTools.fsDirToFileUrl(commandLineOptions.outroot),
    cdnroot = commandLineOptions.cdnroot && urlTools.ensureTrailingSlash(commandLineOptions.cdnroot),
    localeIds = commandLineOptions.locale && _.flatten(_.flatten([commandLineOptions.locale]).map(function (localeId) {return localeId.split(",");}));

new AssetGraph({root: commandLineOptions.root}).on('afterTransform', function (transform, elapsedTime) {
    console.log((elapsedTime / 1000).toFixed(3) + " secs: " + transform.name);
}).on('error', function (err) {
    console.error(err.stack);
    process.exit(1);
}).queue(
    commandLineOptions.label && transforms.registerLabelsAsCustomProtocols(commandLineOptions.label),
    transforms.loadAssets(commandLineOptions._.map(urlTools.fsFilePathToFileUrl)),
    transforms.populate({followRelations: query.or({to: {type: 'I18N'}}, {type: query.not(['JavaScriptStaticInclude', 'JavaScriptExtJS4Include']), to: {url: query.not(/^https?:/)}})}),
    transforms.stripDevelopmentModeFromOneBootstrapper({type: 'HTML', isInitial: true}),
    transforms.removeRelations({type: 'JavaScriptStaticInclude'}, {detach: true, unresolved: true}),
    transforms.convertCSSImportsToHTMLStyles(),
    transforms.removeEmptyAssets({type: ['CSS', 'JavaScript']}),
    transforms.externalizeRelations({type: ['HTMLStyle', 'HTMLScript']}),
    transforms.mergeIdenticalAssets({type: ['JavaScript', 'CSS']}),
    transforms.spriteBackgroundImages(),
    transforms.postProcessBackgroundImages(),
    transforms.bundleAssets({type: 'CSS', incoming: {type: 'HTMLStyle', node: function (node) {return !node.getAttribute('media');}}}),
    transforms.bundleAssets({type: 'JavaScript', incoming: {type: 'HTMLScript'}}),
    transforms.compressJavaScript({type: 'JavaScript'}),
    localeIds && transforms.cloneForEachLocale({type: 'HTML', isInitial: true}, localeIds),
    transforms.removeAssets({type: 'I18N'}),
    commandLineOptions.manifest && transforms.addCacheManifestSinglePage({isInitial: true}),
    transforms.minifyAssets(),
    transforms.computeSerializedSize({type: ['JavaScript', 'CSS']}),
    transforms.inlineRelations({type: ['HTMLStyle', 'HTMLScript'], to: {serializedSize: function (serializedSize) {return serializedSize < 4096;}}}),
    transforms.moveAssetsToDirectory({isInitial: query.not(true), type: query.not('CacheManifest')}, '/static'),
    cdnroot && transforms.moveAssetsToNewRoot({type: ['PNG', 'GIF', 'JPEG', 'ICO', 'CSS', 'JavaScript', 'CacheManifest']}, cdnroot),
    transforms.renameAssetsToMD5Prefix({isInitial: query.not(true), type: query.not('CacheManifest')}),
    transforms.parallel(
        transforms.writeAssetsToDisc({url: /^file:/}, outroot),
        cdnroot && transforms.writeAssetsToDisc({url: query.createPrefixMatcher(cdnroot)}, outroot, cdnroot)
    ),
    transforms.stats()
).run();
