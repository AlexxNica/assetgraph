#!/usr/bin/env node

var _ = require('underscore'),
    AssetGraph = require('../lib/AssetGraph'),
    transforms = require('../lib/transforms'),
    fileUtils = require('../lib/fileUtils'),
    commandLineOptions = require('../lib/camelOptimist')({usage: 'FIXME', demand: ['root']});

new AssetGraph({root: commandLineOptions.root}).transform(
    transforms.registerLabelsAsCustomProtocols(_.flatten(commandLineOptions.label)),
    transforms.loadAssets(commandLineOptions._.map(fileUtils.fsFilePathToFileUrl)),
    transforms.populate({type: ['HTMLScript', 'JavaScriptStaticInclude', 'CSSBackgroundImage']}),
    transforms.flattenStaticIncludes(),
    transforms.runJavaScriptConditionalBlocks({type: 'HTML'}, 'buildDevelopment'),
    transforms.inlineAssets({url: fileUtils.makeFileUrlMatcher(commandLineOptions.inline)}), // FIXME: OR queries?
    transforms.moveAssets({isInitial: true}, function (asset) {return asset.url.replace(/\.template$/, "");}),
    transforms.writeAssetsToDisc({isInitial: true})
);
