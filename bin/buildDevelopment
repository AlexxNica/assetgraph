#!/usr/bin/env node

var AssetGraph = require('../lib/AssetGraph'),
    transforms = require('../lib/transforms'),
    fileUtils = require('../lib/fileUtils'),
    commandLineOptions = require('../lib/camelOptimist')({usage: 'FIXME', demand: ['root']});

new AssetGraph({root: commandLineOptions.root + '/'}).transform(
    transforms.registerLabelsAsCustomProtocols(commandLineOptions.label || []),
    transforms.loadAssets(commandLineOptions._.map(fileUtils.fsFilePathToFileUrl)),
    transforms.populate(function (relation) {
        return ['HTMLScript', 'JavaScriptStaticInclude', 'JavaScriptIfEnvironment', 'HTMLStyle', 'CSSBackgroundImage'].indexOf(relation.type) !== -1;
    }),
    transforms.flattenStaticIncludes(),
    transforms.executeJavaScript({environment: 'buildDevelopment'}),
    transforms.inlineAssets(function (asset) {
        return asset.isDirty;
    }),
    transforms.writeInitialAssetsBackToDisc()
);
