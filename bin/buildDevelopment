#!/usr/bin/env node

var _ = require('underscore'),
    AssetGraph = require('../lib/AssetGraph'),
    transforms = require('../lib/transforms'),
    query = require('../lib/query'),
    fileUtils = require('../lib/fileUtils'),
    commandLineOptions = require('optimist').
        usage('$0 [--label <labelName>=<dir> ...] --root <inputRootDirectory> <htmlFile> ...').
        demand(['root']).
        camelCase().
        argv;

new AssetGraph({root: commandLineOptions.root}).transform(
    transforms.registerLabelsAsCustomProtocols(commandLineOptions.label),
    transforms.loadAssets(commandLineOptions._.map(fileUtils.fsFilePathToFileUrl)),
    transforms.populate({type: ['HTMLScript', 'JavaScriptStaticInclude', 'CSSImage'], to: query.not(/^https?:/)}),
    transforms.injectOneBootstrapper({isInitial: true}),
    transforms.flattenStaticIncludes({isInitial: true}),
    transforms.inlineAssets({isDirty: true, type: 'CSS', incoming: {type: 'HTMLStyle', from: {isInitial: true, type: 'HTML'}}}),
    transforms.convertHTMLStylesToInlineCSSImports(),
    transforms.inlineAssets({isDirty: true, type: 'JavaScript', incoming: {type: 'HTMLScript', from: {isInitial: true, type: 'HTML'}}}),
    transforms.prettyPrintAssets({type: 'JavaScript', incoming: {type: 'HTMLScript', from: {isInitial: true, type: 'HTML'}}}),
    transforms.prettyPrintAssets({type: 'CSS', incoming: {type: 'HTMLStyle', from: {isInitial: true, type: 'HTML'}}}),
    transforms.runJavaScriptConditionalBlocks({type: 'HTML'}, 'buildDevelopment'),
    commandLineOptions.inline ? transforms.inlineAssets({url: fileUtils.makeFileUrlMatcher(commandLineOptions.inline)}) : transforms.noop(),
    transforms.prettyPrintAssets({isInitial: true}),
    transforms.moveAssets({isInitial: true}, function (asset) {return asset.url.replace(/\.template$/, "");}),
    transforms.writeAssetsToDisc({isInitial: true}),
    transforms.reportErrorAndTerminate()
);
